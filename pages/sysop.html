<!DOCTYPE html>
<html>

<head>
    <title>TA Manager | McGill University</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
</head>

<body>

    <div class="top-banner">
        <div class="logout-icon">
            <a href="javascript:void(0);" id="logout" onclick="">
                <i class="fa-solid fa-right-from-bracket"></i> Log Out
            </a>
        </div>

        <div class="user-icon">
            <i class="fa-solid fa-user-check"></i> jules.niyonkuru@mail.mcgill.ca
        </div>
    </div>

    <div class="cs-logo">
        <a href="dashboard.html"><img src="../assets/McGill-CS.png" alt="McGill Logo"></a>
    </div>

    <div class="header"></div>

    <div class="global-container">

        <div class="global-sidebar">
            <button class="sidebar-btn" id="sysop_b1" onclick="return update_page('sysop_b1')">Manage users</button>
            <button class="sidebar-btn" id="sysop_b2" onclick="return update_page('sysop_b2')">Import Course from CSV</button>
            <button class="sidebar-btn" id="sysop_b3" onclick="return update_page('sysop_b3')">Manually Add a Course</button>    
        </div>

        <div class="global-main">
            
            <h1>Sysop</h1>
            <div class="sysop manage-users">
                <h3>Manage Users</h3>
                <div id="manage-users-header">
                    <input oninput="return update_content()" id="search-user" type="search" name="search-user" placeholder="Search">
                    <button onclick="location.href = 'register.html';" >Add user</button>
                </div>
                <div>
                    <table >
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Roles</th>
                                <th>Course</th>
                                <th>Semester</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="table">

                        </tbody>
                        
                    </table>
                </div>
            </div>
            <div class="sysop import-prof">
                <h3>Import courses from CSV</h3>
                <form id="import-course">
                    <input type="file" id="sysop-filepicker" accept=".csv">
                    <button type="submit" id="submit-file">Import</button>
                </form>
            </div>
            <div class="sysop add-prof">
                <h3>Manually Add a Course</h3>
                <form id="manual-add-course-form">
                    <table>
                        <tbody>
                          <tr>
                            <td>Term</td>
                            <td>
                                <input type="radio" id="fall" name="term" value="fall" required>
                                <label for="fall">Fall</label>
                                <input type="radio" id="winter" name="term" value="winter">
                                <label for="winter">Winter</label>
                                <input type="radio" id="summer" name="term" value="summer">
                                <label for="summer">Summer</label>
                            </td>
                          </tr>
                          <tr>
                            <td>Year</td>
                            <td>
                                <input type="number" min="1900" max="2099" step="1" value="2022" required>
                            </td>
                          </tr>
                          <tr>
                            <td>Course Number</td>
                            <td>
                                <input id="course-num" type="text" placeholder="COMP307" required>
                            </td>
                          </tr>
                          <tr>
                            <td>Course Name</td>
                            <td>
                                <input id="course-name" type="text" placeholder="Web Development" required>
                            </td>
                          </tr>
                          <tr>
                            <td>Instructor Name</td>
                            <td>
                                <input id="instructor-name" type="text" placeholder="Joseph Vybihal" required>
                            </td>
                          </tr>
                        </tbody>
                        </table>
                        <button id="submit-course" type="submit">Add Course</button>
                </form>
            </div>
            
        </div>
    </div>

    <div class="footer">
        <div class="mcgill">
            McGill University
        </div>
        <div class="copyright">
            &copy; Lilia Haché, Adrien Philardeau, César Niyonkuru
        </div>
    </div>
    
    <script>
        get_data('')

        function update_content(){
            get_data(document.getElementById("search-user").value);
            return false;
        }

        function edit_options(id){
            //Display the currently selected row only
            let curr = document.getElementsByClassName(id);
            curr = curr[0]
            //Clear first all the other previously opened edit options
            let open_options = document.getElementsByClassName("edit-options");
            for (let i=0; i< open_options.length; i++){
                if (open_options[i]!==curr){
                    open_options[i].style.display='none'
                }
            }
            
            if (curr.style.display !== 'block'){
                curr.style.display = 'block';
            }else{
                curr.style.display = 'none';
            }     
        }

        function update_page(id){
            let menus = document.getElementsByClassName("sidebar-btn");
            let menu_id = {
                'sysop_b1':'manage-users',
                'sysop_b2':'import-prof',
                'sysop_b3':'add-prof'
            }
            
            for(let i=0; i<menus.length; i++){
                main = document.getElementsByClassName(menu_id[menus[i].id]);
                if (menus[i].id !== id){
                    menus[i].style.backgroundColor="white";
                    main[0].style.display = "none"
                }else{
                    menus[i].style.backgroundColor="#f4f4f4";
                    main[0].style.display = "block"
                }              
            }

            return false;
        }
        
        function get_data(username){

            var request = new XMLHttpRequest();
            request.open('GET', 'https://www.cs.mcgill.ca/~aphila/cgi-bin/sysop.py');
            request.onload = function(){
                var data = request.responseText;
                var htmlObject = document.createElement('div');
                htmlObject.innerHTML = data;
                tags = htmlObject.getElementsByTagName("h2");
                table = document.getElementById('table');
                var users = [];
                for (var i = 0; i < tags.length; i++){
                    users.push(tags[i].innerHTML.split(','));
                }
                var htmlObject = document.createElement('div');
                htmlObject.innerHTML = data;
                $("#table").empty();
                if (username.length > 0){
                    users = users.filter((user)=>user[0].startsWith(username));
                }
                for (var i = 0; i < users.length; i++){
                    var newRow = table.insertRow(table.length);
                    for(var j=0; j<users[i].length; j++){
                        var cell = newRow.insertCell(j);
                        cell.innerHTML = users[i][j];
                    } 
                    //get a unique hash to be used as an ID
                    let row_id = `${users[i][0]}-${users[i][2]}-${users[i][3]}`;
                    var cell = newRow.insertCell(users[i].length);
                    cell.innerHTML = '<div class="edit-icon" ><i onclick=\'edit_options("'+ row_id + '")\' class="fa-solid fa-pen-to-square"></i> </div> <div class="edit-options '+ row_id +'"> \
                        <a href="javascript:;" onclick=\'return edit_row(this.parentNode)\'> \
                            <font color="black">Edit</font></a> <br></br> \
                        <a href="javascript:;" onclick=\'return delete_row(this.parentNode)\'> \
                            <font color="red">Delete</font></a> </div>';
                }       
            }

            request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            request.send();
        }

        function edit_row(row_id){
            row_id = row_id.getAttribute('class').split(" ")
            //TODO!!!! Make this list extended with all the other user data from the Database
            data_to_edit = row_id[1].split("-");
            //store the data to session storage and access them from the register page
            sessionStorage.setItem("email", data_to_edit[0]);
            sessionStorage.setItem("course", data_to_edit[1]);
            sessionStorage.setItem("term", data_to_edit[2]);

            window.location = "./register.html"

            return false;
        }

        function delete_row(row_id){
            row_id = row_id.getAttribute('class').split(" ")
            data_to_delete = row_id[1].split("-");
            //Use an HTTP Request to delete from the Database the data corresponding to the username, course, and Semester above
            console.log(data_to_delete)

            return false;
        }

    </script>
</body>

</html>